{% comment %}
  Game Popup App Embed - Automatically injected into storefront
{% endcomment %}

{% comment %} Sticky Button {% endcomment %}
<div id="sticky-button-container" style="display: none; position: fixed; z-index: 9999;">
  <button id="sticky-button-close" style="
    position: fixed;
    width: 24px;
    height: 24px;
    border-radius: 50%;
    border: none;
    font-size: 14px;
    font-weight: bold;
    line-height: 1;
    cursor: pointer;
    display: none;
    align-items: center;
    justify-content: center;
    z-index: 10000;
    padding: 0;
  ">×</button>
  <button id="sticky-button" style="
    background-color: #000000;
    color: white;
    border: none;
    border-radius: 0px;
    padding: 12px 24px;
    font-size: 16px;
    font-weight: 600;
    font-family: 'Poppins', sans-serif;
    cursor: pointer;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
    white-space: nowrap;
  ">Discount Game</button>
</div>

<div id="game-popup-container" style="display: none;">
    <div id="game-popup-overlay" style="
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.7);
      z-index: 9998;
      display: flex;
      align-items: center;
      justify-content: center;
    ">
      <div id="game-popup-content" style="
        background: white;
        border-radius: 0px;
        padding: 0rem;
        max-width: 70%;
        width: 900px;
        max-height: 90%;
        height: 700px;
        overflow: hidden;
        position: relative;
        box-shadow: 0 10px 40px rgba(0,0,0,0.3);
        display: flex;
        flex-direction: column;
      ">
        <button id="game-popup-close" style="
          position: absolute;
          top: 10px;
          right: 10px;
          background: none;
          border: none;
          font-size: 24px;
          cursor: pointer;
          color: #666;
          z-index: 1001;
        ">×</button>

        <div id="game-popup-logo" style="
          display: none;
          background: white;
          padding: 0 0px;
          flex-shrink: 0;
          align-items: center;
          justify-content: center;
        ">
          <img id="game-popup-logo-img" src="" alt="Logo" style="
            object-fit: contain;
          " />
        </div>

        <div id="game-popup-header" style="
          background: white;
          padding: 20px 20px;
          border-bottom: 1px solid #e0e0e0;
          flex-shrink: 0;
          position: relative;
          display: flex;
          align-items: center;
          justify-content: center;
        ">
          <h2 id="game-popup-title" style="
            text-align: center;
            margin: 0;
            color: #333;
            font-size: 1.8em;
            font-weight: 600;
            font-family: 'Poppins', sans-serif;
          ">Discount Game</h2>
        </div>

        <div id="email-form-container" style="display: none; flex: 1; padding: 20px; overflow-y: auto; background: white;">
            <h2 style="margin-top: 0;">Sign up to play!</h2>
            <form id="email-signup-form">
              <input 
                type="email" 
                id="player-email" 
                placeholder="Enter your email"
                required
                style="
                  width: 100%;
                  padding: 0.75rem;
                  margin-bottom: 1rem;
                  border: 1px solid #ccc;
                  border-radius: 0px;
                  font-size: 1rem;
                "
              />
              <button 
                type="submit"
                style="
                  width: 100%;
                  padding: 0.75rem;
                  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                  color: white;
                  border: none;
                  border-radius: 0px;
                  font-size: 1rem;
                  cursor: pointer;
                  font-weight: bold;
                "
              >
                Start Playing
              </button>
            </form>
          </div>

        <div id="game-container" style="display: none; flex: 1; display: flex; flex-direction: column; min-height: 0;">
          <iframe 
            id="game-iframe" 
            src="" 
            style="
              width: 100%;
              height: 100%;
              border: none;
              border-radius: 0px;
              flex: 1;
            "
          ></iframe>
        </div>
      </div>
    </div>
  </div>

<style>
  @import url('https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700;800&display=swap');
  
  @media (max-width: 768px) {
    #game-popup-content {
      max-width: 85% !important;
      height: 75vh !important;
    }
  }
</style>

  <script>
    // Listen for messages from iframe to close popup
    window.addEventListener('message', function(event) {
      if (event.data === 'closeGamePopup') {
        const container = document.getElementById('game-popup-container');
        if (container) {
          container.style.display = 'none';
        }
      }
    });

    (function() {
      const shop = '{{ shop.permanent_domain }}';
      const appUrl = 'https://discount-game-popup-production.up.railway.app';
      
      // Generate unique sessionId for this popup instance
      function generateSessionId() {
        return 'session_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
      }
      
      // Track popup view
      function trackPopupView(sessionId, device) {
        fetch(appUrl + '/api/track-popup-view', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({
            shop: shop,
            sessionId: sessionId,
            device: device
          })
        }).catch(error => {
          console.error('Failed to track popup view:', error);
        });
      }
      
      // Fetch game settings from API
      const settingsUrl = appUrl + '/api/settings?shop=' + shop;
      
      fetch(settingsUrl)
        .then(response => {
          if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
          }
          return response.json();
        })
        .then(data => {
          
          // Only show if both enabled AND isActive are explicitly true
          if (!data.enabled || data.isActive !== true) {
            return; // Don't show if disabled or not active
          }

          const gameType = data.selectedGame || 'horizontal-lines';
          const requireEmailToClaim = data.requireEmailToClaim !== undefined ? data.requireEmailToClaim : false;
          const requireName = data.requireName !== undefined ? data.requireName : false;
          const popupDelay = data.popupDelay || '0';
          const popupDisplayPage = data.popupDisplayPage || 'any';
          const popupCustomUrls = data.popupCustomUrls || [];
          const popupText = data.popupText || 'Discount Game';
          const mainText = data.mainText || 'Discount Game';
          const mainTextColor = data.mainTextColor || '#000000';
          const mainTextSize = data.mainTextSize || '24';
          const mainTextBgColor = data.mainTextBgColor || '#ffffff';
          const mainTextWeight = data.mainTextWeight || '600';
          const borderRadius = data.borderRadius !== undefined ? data.borderRadius : 10;
          const gameEndBorderRadius = data.gameEndBorderRadius !== undefined ? data.gameEndBorderRadius : 10;
          const emailModalBorderRadius = data.emailModalBorderRadius !== undefined ? data.emailModalBorderRadius : 10;
          const discountModalBorderRadius = data.discountModalBorderRadius !== undefined ? data.discountModalBorderRadius : 10;
          const backgroundColor = data.backgroundColor || '#ffffff';
          const ballColor = data.ballColor || '#000000';
          const obstacleColor = data.obstacleColor || '#ff0000';
          const gameDifficulty = data.gameDifficulty !== undefined ? data.gameDifficulty : 50;
          const maxDiscount = data.maxDiscount || '100';
          const countdownTime = data.countdownTime !== undefined ? data.countdownTime : 10;
          const claimBestButtonText = data.claimBestButtonText || 'Claim Best Discount';
          const claimBestButtonTextColor = data.claimBestButtonTextColor || '#ffffff';
          const claimBestButtonTextSize = data.claimBestButtonTextSize || '16';
          const claimBestButtonTextWeight = data.claimBestButtonTextWeight || '500';
          const gameEndTabBgColor = data.gameEndTabBgColor || '#ffffff';
          const buttonBgColor = data.buttonBgColor || '#000000';
          const claimBestButtonBgColor = data.claimBestButtonBgColor || '#000000';
          const logoUrl = data.logoUrl || null;
          const logoUrlMobile = data.logoUrlMobile || null;
          const logoScale = data.logoScale !== undefined ? data.logoScale : 100;
          const logoScaleMobile = data.logoScaleMobile !== undefined ? data.logoScaleMobile : 100;
          const logoHeightDesktop = data.logoHeightDesktop || 'small';
          const logoHeightMobile = data.logoHeightMobile || 'small';
          
          // Helper function to get height in pixels
          const getHeaderHeight = (size, isMobile) => {
            if (isMobile) {
              switch(size) {
                case 'small': return 60;
                case 'medium': return 70;
                case 'large': return 80;
                default: return 60;
              }
            } else {
              switch(size) {
                case 'small': return 70;
                case 'medium': return 90;
                case 'large': return 110;
                default: return 70;
              }
            }
          };
          
          // Sticky Button Settings
          const showStickyButton = data.showStickyButton !== undefined ? data.showStickyButton : false;
          const stickyButtonText = data.stickyButtonText || 'Discount Game';
          const stickyButtonColor = data.stickyButtonColor || '#000000';
          const stickyButtonTextColor = data.stickyButtonTextColor || '#ffffff';
          const stickyButtonPosition = data.stickyButtonPosition || 'right';
          const stickyButtonDisplayPage = data.stickyButtonDisplayPage || 'any';
          const stickyButtonCustomUrls = data.stickyButtonCustomUrls || [];
          const stickyButtonShowOnDesktop = data.stickyButtonShowOnDesktop !== undefined ? data.stickyButtonShowOnDesktop : true;
          const stickyButtonShowOnMobile = data.stickyButtonShowOnMobile !== undefined ? data.stickyButtonShowOnMobile : true;
          const showPopupHeaderText = data.showPopupHeaderText !== undefined ? data.showPopupHeaderText : true;
          
          // Helper function to check if current page matches display settings
          function shouldShowOnCurrentPage(displayPage, customUrls) {
            if (displayPage === 'any') {
              return true;
            }
            if (displayPage === 'custom' && customUrls && customUrls.length > 0) {
              const currentPath = window.location.pathname;
              const currentHref = window.location.href;
              // Check if current path or href matches any custom URL
              return customUrls.some(url => {
                if (!url || url.trim() === '') return false;
                const normalizedUrl = url.trim();
                // Remove leading/trailing slashes for comparison
                const urlPath = normalizedUrl.replace(/^\/+|\/+$/g, '');
                const currentPathNormalized = currentPath.replace(/^\/+|\/+$/g, '');
                // Check if pathname matches or if URL is contained in href
                return currentPathNormalized === urlPath || 
                       currentPathNormalized.endsWith('/' + urlPath) ||
                       currentPathNormalized.startsWith(urlPath + '/') ||
                       currentHref.includes(normalizedUrl);
              });
            }
            return false;
          }
          
          // Check if popup should show on current page
          const shouldShowPopup = shouldShowOnCurrentPage(popupDisplayPage, popupCustomUrls);
          
          // Check if sticky button should show on current page
          const shouldShowStickyButtonOnPage = shouldShowOnCurrentPage(stickyButtonDisplayPage, stickyButtonCustomUrls);
          
          const today = new Date().toDateString();
          
          // Store timeout ID and initialization flag (before sticky button setup)
          let popupTimeoutId = null;
          let popupInitialized = false;
          
          // Extract initialization logic into a reusable function
          function initializePopup() {
            // Prevent double initialization
            if (popupInitialized) return;
            popupInitialized = true;
            
            const container = document.getElementById('game-popup-container');
            const overlay = document.getElementById('game-popup-overlay');
            const emailForm = document.getElementById('email-form-container');
            const gameContainer = document.getElementById('game-container');
            const gameIframe = document.getElementById('game-iframe');
            const closeBtn = document.getElementById('game-popup-close');
            const emailFormEl = document.getElementById('email-signup-form');
            const emailInput = document.getElementById('player-email');
            const popupTitle = document.getElementById('game-popup-title');
            const popupContent = document.getElementById('game-popup-content');
            const popupHeader = document.getElementById('game-popup-header');
            const popupLogo = document.getElementById('game-popup-logo');
            const popupLogoImg = document.getElementById('game-popup-logo-img');

            if (!container) return;
            
            // Function to get the correct logo URL based on device
            const getCurrentLogoUrl = () => {
              const isMobileNow = window.innerWidth <= 768;
              // Use mobile logo if available, otherwise fall back to desktop logo
              if (isMobileNow && logoUrlMobile && logoUrlMobile.trim() !== '') {
                return logoUrlMobile;
              } else if (logoUrl && logoUrl.trim() !== '') {
                return logoUrl;
              }
              return null;
            };
            
            // Show logo if a logo URL is available
            const currentLogoUrl = getCurrentLogoUrl();
            if (currentLogoUrl && popupLogo && popupLogoImg) {
              // Function to update logo URL and size based on mobile/desktop state
              const updateLogo = () => {
                const isMobileNow = window.innerWidth <= 768;
                const newLogoUrl = getCurrentLogoUrl();
                const currentLogoScale = isMobileNow ? logoScaleMobile : logoScale;
                const currentHeightSetting = isMobileNow ? logoHeightMobile : logoHeightDesktop;
                const containerHeight = getHeaderHeight(currentHeightSetting, isMobileNow);
                // Use fixed base size for image calculation (small size)
                const fixedBaseHeight = isMobileNow ? 60 : 70; // Always use 'small' as base
                const scaleFactor = 1 + currentLogoScale / 25;
                const scaledHeight = fixedBaseHeight * scaleFactor;
                
                // Update logo URL if it changed
                if (newLogoUrl && popupLogoImg.src !== newLogoUrl) {
                  popupLogoImg.src = newLogoUrl;
                }
                
                if (popupLogo) {
                  popupLogo.style.height = containerHeight + 'px';
                  popupLogo.style.overflow = 'hidden';
                }
                
                if (popupLogoImg) {
                  popupLogoImg.style.maxHeight = scaledHeight + 'px';
                  popupLogoImg.style.height = scaledHeight + 'px';
                  popupLogoImg.style.width = 'auto';
                  popupLogoImg.style.transform = 'none';
                  popupLogoImg.style.transformOrigin = 'center center';
                }
              };
              
              // Set initial logo styles
              popupLogo.style.display = 'flex';
              popupLogoImg.src = currentLogoUrl;
              popupLogoImg.style.display = 'block';
              popupLogoImg.style.objectFit = 'contain';
              
              // Apply initial sizing
              updateLogo();
              
              // Handle image load success
              popupLogoImg.onload = function() {
                updateLogo(); // Reapply sizing after image loads
              };
              
              // Handle image load errors
              popupLogoImg.onerror = function() {
                console.error('Failed to load logo image:', popupLogoImg.src);
                if (popupLogo) {
                  popupLogo.style.display = 'none';
                }
              };
              
              // Add resize handler to update logo URL and scaling dynamically
              window.addEventListener('resize', updateLogo);
              window.addEventListener('orientationchange', () => {
                setTimeout(updateLogo, 200);
              });
            } else {
              if (popupLogo) {
                popupLogo.style.display = 'none';
              }
            }

            // Set popup title text and styles
            if (popupTitle) {
              popupTitle.textContent = mainText;
              popupTitle.style.color = mainTextColor;
              
              // Function to update popup title font size based on mobile state
              const updatePopupTitleSize = () => {
                const isMobile = window.innerWidth <= 768;
                const mobileScaleFactor = 0.85;
                const adjustedTextSize = isMobile ? parseFloat(mainTextSize) * mobileScaleFactor : parseFloat(mainTextSize);
                popupTitle.style.fontSize = adjustedTextSize + 'px';
                popupTitle.style.lineHeight = adjustedTextSize + 'px';
              };
              
              // Apply initial mobile scaling
              updatePopupTitleSize();
              
              popupTitle.style.margin = '0';
              popupTitle.style.padding = '0';
              popupTitle.style.fontFamily = "'Poppins', sans-serif";
              popupTitle.style.fontWeight = mainTextWeight.toString();
              popupTitle.style.textAlign = 'center';
              popupTitle.style.width = '100%';
              popupTitle.style.letterSpacing = 'normal';
              
              // Add resize handler to update popup title font size dynamically
              window.addEventListener('resize', updatePopupTitleSize);
              
              // Also handle orientation change
              window.addEventListener('orientationchange', () => {
                setTimeout(updatePopupTitleSize, 200);
              });
            }

            // Set popup header background color and flexbox centering
            // Show/hide header based on showPopupHeaderText setting
            if (popupHeader) {
              if (showPopupHeaderText && mainText && mainText.trim() !== '') {
                popupHeader.style.backgroundColor = mainTextBgColor;
                popupHeader.style.borderBottom = 'none';
                popupHeader.style.display = 'flex';
                popupHeader.style.alignItems = 'center';
                popupHeader.style.justifyContent = 'center';
              } else {
                popupHeader.style.display = 'none';
              }
            }

            // Set popup border radius
            if (popupContent) {
              popupContent.style.borderRadius = borderRadius + 'px';
            }

            // Generate sessionId and detect device
            const sessionId = generateSessionId();
            const device = window.innerWidth <= 768 ? 'Mobile' : 'Desktop';
            
            // Track popup view
            trackPopupView(sessionId, device);
            
            // Set game iframe source with color parameters, difficulty, maxDiscount, countdownTime, and text settings
            const gamePath = appUrl + '/games/' + gameType + '/index.html' +
              '?shop=' + encodeURIComponent(shop) +
              '&sessionId=' + encodeURIComponent(sessionId) +
              '&device=' + encodeURIComponent(device) +
              '&bg=' + encodeURIComponent(backgroundColor) +
              '&ball=' + encodeURIComponent(ballColor) +
              '&obstacle=' + encodeURIComponent(obstacleColor) +
              '&difficulty=' + encodeURIComponent(gameDifficulty) +
              '&maxDiscount=' + encodeURIComponent(maxDiscount) +
              '&borderRadius=' + encodeURIComponent(borderRadius) +
              '&gameEndBorderRadius=' + encodeURIComponent(gameEndBorderRadius) +
              '&emailModalBorderRadius=' + encodeURIComponent(emailModalBorderRadius) +
              '&discountModalBorderRadius=' + encodeURIComponent(discountModalBorderRadius) +
              '&mainText=' + encodeURIComponent(data.mainText || 'Discount Game') +
              '&mainTextSize=' + encodeURIComponent(data.mainTextSize || '24') +
              '&mainTextColor=' + encodeURIComponent(data.mainTextColor || '#000000') +
              '&mainTextBgColor=' + encodeURIComponent(data.mainTextBgColor || '#ffffff') +
              '&secondaryText=' + encodeURIComponent(data.secondaryText || 'Discount:') +
              '&secondaryTextColor=' + encodeURIComponent(data.secondaryTextColor || '#000000') +
              '&secondaryTextSize=' + encodeURIComponent(data.secondaryTextSize || '18') +
              '&secondaryTextWeight=' + encodeURIComponent(data.secondaryTextWeight || '400') +
              '&rulesText=' + encodeURIComponent(data.rulesText || '1 Score - 1% Discount') +
              '&rulesTextColor=' + encodeURIComponent(data.rulesTextColor || '#000000') +
              '&rulesTextSize=' + encodeURIComponent(data.rulesTextSize || '14') +
              '&rulesTextWeight=' + encodeURIComponent(data.rulesTextWeight || '400') +
              '&instructionText=' + encodeURIComponent(data.instructionText || 'Click to Bounce') +
              '&instructionTextColor=' + encodeURIComponent(data.instructionTextColor || '#000000') +
              '&instructionTextSize=' + encodeURIComponent(data.instructionTextSize || '16') +
              '&instructionTextWeight=' + encodeURIComponent(data.instructionTextWeight || '400') +
              '&gameEndText=' + encodeURIComponent(data.gameEndText || 'Your Discount') +
              '&gameEndTextColor=' + encodeURIComponent(data.gameEndTextColor || '#000000') +
              '&gameEndTextSize=' + encodeURIComponent(data.gameEndTextSize || '20') +
              '&gameEndTextWeight=' + encodeURIComponent(data.gameEndTextWeight || '400') +
              '&buttonText=' + encodeURIComponent(data.buttonText || 'Play Again') +
              '&buttonTextColor=' + encodeURIComponent(data.buttonTextColor || '#ffffff') +
              '&buttonTextSize=' + encodeURIComponent(data.buttonTextSize || '16') +
              '&buttonTextWeight=' + encodeURIComponent(data.buttonTextWeight || '500') +
              '&claimBestButtonText=' + encodeURIComponent(data.claimBestButtonText || 'Claim Best Discount') +
              '&claimBestButtonTextColor=' + encodeURIComponent(data.claimBestButtonTextColor || '#ffffff') +
              '&claimBestButtonTextSize=' + encodeURIComponent(data.claimBestButtonTextSize || '16') +
              '&claimBestButtonTextWeight=' + encodeURIComponent(data.claimBestButtonTextWeight || '500') +
              '&gameEndTabBgColor=' + encodeURIComponent(data.gameEndTabBgColor || '#ffffff') +
              '&buttonBgColor=' + encodeURIComponent(data.buttonBgColor || '#000000') +
              '&claimBestButtonBgColor=' + encodeURIComponent(data.claimBestButtonBgColor || '#000000') +
              '&requireEmailToClaim=' + encodeURIComponent(requireEmailToClaim ? 'true' : 'false') +
              '&requireName=' + encodeURIComponent(requireName ? 'true' : 'false') +
              '&shop=' + encodeURIComponent(shop) +
              // Email Modal Settings
              '&emailModalHeadingText=' + encodeURIComponent(data.emailModalHeadingText || 'Enter Your Email') +
              '&emailModalHeadingColor=' + encodeURIComponent(data.emailModalHeadingColor || '#333333') +
              '&emailModalHeadingSize=' + encodeURIComponent(data.emailModalHeadingSize || '20') +
              '&emailModalHeadingWeight=' + encodeURIComponent(data.emailModalHeadingWeight || '600') +
              '&emailModalDescriptionText=' + encodeURIComponent(data.emailModalDescriptionText || 'Please enter your email to claim your discount:') +
              '&emailModalDescriptionColor=' + encodeURIComponent(data.emailModalDescriptionColor || '#333333') +
              '&emailModalDescriptionSize=' + encodeURIComponent(data.emailModalDescriptionSize || '14') +
              '&emailModalDescriptionWeight=' + encodeURIComponent(data.emailModalDescriptionWeight || '400') +
              '&emailModalSubmitText=' + encodeURIComponent(data.emailModalSubmitText || 'Submit') +
              '&emailModalSubmitColor=' + encodeURIComponent(data.emailModalSubmitColor || '#ffffff') +
              '&emailModalSubmitSize=' + encodeURIComponent(data.emailModalSubmitSize || '16') +
              '&emailModalSubmitWeight=' + encodeURIComponent(data.emailModalSubmitWeight || '500') +
              '&emailModalCancelText=' + encodeURIComponent(data.emailModalCancelText || 'Cancel') +
              '&emailModalCancelColor=' + encodeURIComponent(data.emailModalCancelColor || '#333333') +
              '&emailModalCancelSize=' + encodeURIComponent(data.emailModalCancelSize || '16') +
              '&emailModalCancelWeight=' + encodeURIComponent(data.emailModalCancelWeight || '500') +
              '&emailModalBgColor=' + encodeURIComponent(data.emailModalBgColor || '#ffffff') +
              '&emailModalSubmitBgColor=' + encodeURIComponent(data.emailModalSubmitBgColor || '#000000') +
              '&emailModalCancelBgColor=' + encodeURIComponent(data.emailModalCancelBgColor || '#cccccc') +
              // Discount Code Modal Settings
              '&discountModalHeadingText=' + encodeURIComponent(data.discountModalHeadingText || 'Your Discount Code') +
              '&discountModalHeadingColor=' + encodeURIComponent(data.discountModalHeadingColor || '#333333') +
              '&discountModalHeadingSize=' + encodeURIComponent(data.discountModalHeadingSize || '20') +
              '&discountModalHeadingWeight=' + encodeURIComponent(data.discountModalHeadingWeight || '600') +
              '&discountModalCloseText=' + encodeURIComponent(data.discountModalCloseText || 'Close') +
              '&discountModalCloseColor=' + encodeURIComponent(data.discountModalCloseColor || '#ffffff') +
              '&discountModalCloseSize=' + encodeURIComponent(data.discountModalCloseSize || '16') +
              '&discountModalCloseWeight=' + encodeURIComponent(data.discountModalCloseWeight || '500') +
              '&discountModalBgColor=' + encodeURIComponent(data.discountModalBgColor || '#ffffff') +
              '&discountModalCloseBgColor=' + encodeURIComponent(data.discountModalCloseBgColor || '#000000') +
              '&discountModalDescriptionText=' + encodeURIComponent(data.discountModalDescriptionText || 'Copy your code and use it at checkout') +
              '&discountModalDescriptionColor=' + encodeURIComponent(data.discountModalDescriptionColor || '#333333') +
              '&discountModalDescriptionSize=' + encodeURIComponent(data.discountModalDescriptionSize || '14') +
              '&discountModalDescriptionWeight=' + encodeURIComponent(data.discountModalDescriptionWeight || '400') +
              (gameType === 'reaction-click' ? '&countdownTime=' + encodeURIComponent(countdownTime) : '');
            if (gameIframe) {
              gameIframe.src = gamePath;
            }

            // Show game directly (no email required before playing)
            // Email will only be required when claiming discount if requireEmailToClaim is true
            if (gameContainer) {
              gameContainer.style.display = 'block';
            }
            if (emailForm) {
              emailForm.style.display = 'none';
            }

            // Close button handler
            if (closeBtn) {
              closeBtn.addEventListener('click', () => {
                container.style.display = 'none';
                const today = new Date().toDateString();
                localStorage.setItem('game-popup-dismissed-' + shop, today);
              });
            }

            // Email form submit handler
            if (emailFormEl && emailInput) {
              emailFormEl.addEventListener('submit', (e) => {
                e.preventDefault();
                const email = emailInput.value;
                
                // Here you could send email to your backend
                
                // Hide email form, show game
                if (emailForm) emailForm.style.display = 'none';
                if (gameContainer) gameContainer.style.display = 'block';
              });
            }

            // Close on overlay click
            if (overlay) {
              overlay.addEventListener('click', (e) => {
                if (e.target === overlay) {
                  container.style.display = 'none';
                  const today = new Date().toDateString();
                  localStorage.setItem('game-popup-dismissed-' + shop, today);
                }
              });
            }
          }
          
          // Show sticky button if enabled and active (check if it was dismissed today)
          if (showStickyButton && data.isActive === true) {
            const stickyButtonDismissed = localStorage.getItem('game-sticky-button-dismissed-' + shop);
            const wasStickyButtonDismissedToday = stickyButtonDismissed === today;
            
            const stickyButtonContainer = document.getElementById('sticky-button-container');
            const stickyButton = document.getElementById('sticky-button');
            const stickyButtonClose = document.getElementById('sticky-button-close');
            
            if (stickyButtonContainer && stickyButton && stickyButtonClose) {
              // Check if should show on current device and page
              const isMobile = window.innerWidth <= 768;
              const shouldShowDevice = (isMobile && stickyButtonShowOnMobile) || (!isMobile && stickyButtonShowOnDesktop);
              const shouldShow = shouldShowDevice && shouldShowStickyButtonOnPage && !wasStickyButtonDismissedToday;
              
              if (shouldShow) {
                stickyButtonContainer.style.display = 'block';
                stickyButtonClose.style.display = 'block';
                stickyButton.textContent = stickyButtonText;
                stickyButton.style.backgroundColor = stickyButtonColor;
                stickyButton.style.color = stickyButtonTextColor;
                
                // Apply close button colors (inverted from button)
                stickyButtonClose.style.backgroundColor = stickyButtonTextColor;
                stickyButtonClose.style.color = stickyButtonColor;
                
                // Apply position styles dynamically
                if (stickyButtonPosition === 'right') {
                  stickyButtonContainer.style.right = '0';
                  stickyButtonContainer.style.top = '40%';
                  stickyButton.style.transform = 'rotate(-90deg) translateY(-50%)';
                  stickyButton.style.transformOrigin = 'center right';
                  // Position close button
                  stickyButtonClose.style.right = '29px';
                  stickyButtonClose.style.top = 'calc(40% + 22px)';
                  stickyButtonClose.style.transform = 'translateY(-50%)';
                } else if (stickyButtonPosition === 'bottom') {
                  stickyButtonContainer.style.bottom = '0';
                  stickyButtonContainer.style.left = '50%';
                  stickyButtonContainer.style.transform = '';
                  stickyButton.style.transform = 'translateX(-50%)';
                  stickyButton.style.transformOrigin = 'center';
                  // Position close button
                  stickyButtonClose.style.bottom = '30px';
                  stickyButtonClose.style.left = 'calc(50% + 82px)';
                  stickyButtonClose.style.transform = 'translateX(-50%)';
                } else if (stickyButtonPosition === 'left') {
                  stickyButtonContainer.style.left = '0';
                  stickyButtonContainer.style.top = '40%';
                  stickyButton.style.transform = 'rotate(90deg) translateY(-50%)';
                  stickyButton.style.transformOrigin = 'center left';
                  // Position close button
                  stickyButtonClose.style.left = '29px';
                  stickyButtonClose.style.top = 'calc(40% + 22px)';
                  stickyButtonClose.style.transform = 'translateY(-50%)';
                }
                
                // Click handler to show popup (only if popup should show on current page)
                stickyButton.addEventListener('click', () => {
                  if (shouldShowPopup) {
                    // Clear the timeout if it hasn't fired yet
                    if (popupTimeoutId) {
                      clearTimeout(popupTimeoutId);
                      popupTimeoutId = null;
                    }
                    
                    // Initialize and show popup
                    initializePopup();
                    const container = document.getElementById('game-popup-container');
                    if (container) {
                      container.style.display = 'block';
                    }
                  }
                });
                
                // Close button click handler
                stickyButtonClose.addEventListener('click', (e) => {
                  e.stopPropagation();
                  stickyButtonContainer.style.display = 'none';
                  stickyButtonClose.style.display = 'none';
                  const today = new Date().toDateString();
                  localStorage.setItem('game-sticky-button-dismissed-' + shop, today);
                });
              }
            }
          }
          
          // Check if popup was dismissed today - if so, skip auto popup setup (early return)
          const popupDismissed = localStorage.getItem('game-popup-dismissed-' + shop);
          if (popupDismissed === today) {
            return; // Don't show auto popup if dismissed today
          }
          
          // Show popup after a delay (only if page check passes)
          if (shouldShowPopup) {
            const delayMs = parseInt(popupDelay, 10) * 1000; // Convert seconds to milliseconds
            popupTimeoutId = setTimeout(() => {
              initializePopup();
              const container = document.getElementById('game-popup-container');
              if (container) {
                container.style.display = 'block';
              }
            }, delayMs);
          }
        })
        .catch(error => {
          console.error('Error fetching game settings:', error);
          // If API fails, don't show popup
        });
    })();
  </script>

{% schema %}
{
  "name": "Game Popup",
  "target": "body"
}
{% endschema %}

